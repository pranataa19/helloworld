<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nata Ai</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <h1>Nata Ai</h1>
        </div>
        <div class="settings">
            <span class="theme-switch" title="Toggle Light/Dark Mode">ðŸŒ™</span>
            <button id="resetButton" class="reset" title="Reset Chat">Reset</button>
        </div>
    </nav>
    
    
    <div class="container">
        <div class="chatbox" id="chatbox"></div>
        <div class="loader" id="loader" style="display: none;">Memproses...</div>
    </div>

    <form id="inputForm">
        <textarea name="user_input" rows="2" placeholder="Ketik pesan..."></textarea>
        <button type="submit">Kirim</button>
    </form>

    <!-- Tombol Reset -->
    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatbox = document.getElementById('chatbox');
            const loader = document.getElementById('loader');
            const inputForm = document.getElementById('inputForm');
            const submitButton = inputForm.querySelector('button');
            const themeSwitch = document.querySelector('.theme-switch');
            const resetButton = document.getElementById('resetButton');

            const loadMessages = () => {
                const messages = JSON.parse(localStorage.getItem('messages')) || [];
                chatbox.innerHTML = '';  // Kosongkan chatbox sebelum memuat ulang
                messages.forEach(message => {
                    chatbox.innerHTML += `<div class="message ${message.sender}"><div class="profile"><img src="${message.profile}" alt="${message.sender}"/></div><div class="bubble">${message.text}</div></div>`;
                });
                chatbox.scrollTop = chatbox.scrollHeight;
            };

            const saveMessage = (sender, text, profile) => {
                const messages = JSON.parse(localStorage.getItem('messages')) || [];
                messages.push({ sender, text, profile });
                localStorage.setItem('messages', JSON.stringify(messages));
            };

            loadMessages();

            inputForm.onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const userMessage = formData.get('user_input').trim();

                if (!userMessage) {
                    alert('Pesan tidak boleh kosong!');
                    return;
                }

                const userProfile = '/static/profileuser.jpeg'; // Sesuaikan jalur gambar profil pengguna
                chatbox.innerHTML += `<div class="message user"><div class="profile"><img src="${userProfile}" alt="User"/></div><div class="bubble">${userMessage}</div></div>`;
                saveMessage('user', userMessage, userProfile);
                chatbox.scrollTop = chatbox.scrollHeight;
                loader.style.display = 'block';  // Menampilkan loader hanya setelah submit
                submitButton.disabled = true;

                try {
                    const response = await fetch('/generate', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (response.ok) {
                        let responseStr = data.split("\n").join("</br>");

                        let responseArray = responseStr.split("**");
                        let responseStr2 = "";
                        for (let i = 0; i < responseArray.length; i++) {
                            if (i === 0 || i % 2 !== 1) {
                                responseStr2 += responseArray[i];
                            } else {
                                responseStr2 += "<strong>" + responseArray[i] + "</strong>";
                            }
                        }

                        let responseArray2 = responseStr2.split("</br>");
                        let responseStr3 = "";
                        let inCodeBlock = false;

                        for (let i = 0; i < responseArray2.length; i++) {
                            const line = responseArray2[i].trim();

                            if (line.startsWith("```bash")) {
                                inCodeBlock = true;
                                responseStr3 += `<pre><code class="language-bash">`;
                            } else if (line.startsWith("```")) {
                                inCodeBlock = false;
                                responseStr3 += `</code></pre>`;
                            } else {
                                if (inCodeBlock) {
                                    responseStr3 += line + "\n";
                                } else {
                                    if (line.startsWith("##")) {
                                        responseStr3 += "<strong>" + line.replace("##", "").trim() + "</strong></br>";
                                    } else if (line.startsWith("*")) {
                                        responseStr3 += `<li>${line.replace("*", "").trim()}</li>`;
                                    } else {
                                        responseStr3 += line + "</br>";
                                    }
                                }
                            }
                        }

                        const aiProfile = '/static/profileai.png'; // Sesuaikan jalur gambar profil AI
                        chatbox.innerHTML += `<div class="message ai"><div class="profile"><img src="${aiProfile}" alt="AI"/></div><div class="bubble">${responseStr3}</div></div>`;
                        saveMessage('ai', responseStr3, aiProfile);

                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    alert('Gagal mengirim pesan. Coba lagi.');
                }

                loader.style.display = 'none';  // Menyembunyikan loader setelah respons diterima
                submitButton.disabled = false;
                e.target.reset();
                chatbox.scrollTop = chatbox.scrollHeight;
            };

            // Fitur reset untuk menghapus semua data chat
            resetButton.onclick = () => {
                if (confirm('Apakah Anda yakin ingin menghapus semua percakapan?')) {
                    localStorage.clear();  // Menghapus semua data di localStorage
                    chatbox.innerHTML = '';  // Mengosongkan chatbox
                    alert('Semua percakapan telah dihapus.');
                }
            };

            themeSwitch.onclick = () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                themeSwitch.textContent = document.body.classList.contains('dark-mode') ? 'ðŸŒž' : 'ðŸŒ™';
            };

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.textContent = 'ðŸŒž';
            } else {
                themeSwitch.textContent = 'ðŸŒ™';
            }
        });
    </script>
</body>

</html>
